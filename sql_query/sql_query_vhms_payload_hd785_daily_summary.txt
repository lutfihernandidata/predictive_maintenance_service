SELECT
    MCHN_SRL_NUM, DATE(TIMESTAMP) AS CYCLE_DATE, 
    SUM(PAYLOAD) SUM_PLD, AVG(PAYLOAD) AVG_PLD, MAX(PAYLOAD) MAX_PLD, MIN(PAYLOAD) MIN_PLD,
    SUM(EMPTY_DRV_TM) SUM_EMPTY_DRV_TIME, AVG(EMPTY_DRV_TM) AVG_EMPTY_DRV_TIME,
    SUM(EMPTY_DRV_DIST) SUM_EMPTY_DRV_DIST, AVG(EMPTY_DRV_DIST) AVG_EMPTY_DRV_DIST, MAX(EMPTY_DRV_DIST) MAX_EMPTY_DRV_DIST,
    SUM(EMPTY_STOP_TM) SUM_EMPTY_STOP_TIME, AVG(EMPTY_STOP_TM) AVG_EMPTY_STOP_TIME, MAX(EMPTY_STOP_TM) MAX_EMPTY_STOP_TIME,
    SUM(LOADING_STOP_TM) SUM_LOADING_STOP_TIME, AVG(LOADING_STOP_TM) AVG_LOADING_STOP_TIME, MAX(LOADING_STOP_TM) MAX_LOADING_STOP_TIME, MIN(LOADING_STOP_TM) MIN_LOADING_STOP_TIME,
    SUM(LOADED_DRV_TM) SUM_LOADED_DRV_TIME, AVG(LOADED_DRV_TM) AVG_LOADED_DRV_TIME,
    SUM(LOADED_DRV_DIST) SIM_LOADED_DRV_DIST, AVG(LOADED_DRV_DIST) AVG_LOADED_DRV_DIST, MAX(LOADED_DRV_DIST) MAX_LOADED_DRV_DIST,
    SUM(LOADED_STOP_TM) SUM_LOADED_STOP_TIME, AVG(LOADED_STOP_TM) AVG_LOADED_STOP_TIME,
    SUM(OV_LOAD) COUNT_OVERLOAD, 
    MIN(ANGLE_MN) MIN_ANGLE,
    AVG(CASE WHEN ANGLE_AV<0 THEN ANGLE_AV ELSE 0 END) AS AVG_NEGATIVE_ANGLE, 
    AVG(CASE WHEN ANGLE_AV>0 THEN ANGLE_AV ELSE 0 END) AS AVG_POSITIVE_ANGLE, 
    MAX(ANGLE_MX) MAX_ANGLE,
    COUNT(*) AS COUNT_CYCLE
FROM(
    SELECT
        MCHN_SRL_NUM, CDR_TM_STMP AS TIMESTAMP, PAYLOAD, EMPTY_DRV_TM, EMPTY_DRV_DIST, 
        EMPTY_STOP_TM, LOADING_STOP_TM, LOADED_DRV_TM, LOADED_DRV_DIST, LOADED_STOP_TM,
        OV_LOAD, ANGLE_MN, ANGLE_AV, ANGLE_MX, PPN_DTTM,
        ROW_NUMBER()OVER(PARTITION BY MCHN_SRL_NUM, CDR_TM_STMP ORDER BY PPN_DTTM DESC) AS RN
    FROM SOR.VHMS_PLDCYCN_HD785 vhms_pldcycn
    WHERE PAYLOAD > 30
) all_paylaod
WHERE RN=1
GROUP BY 1,2
ORDER BY 1,2 DESC