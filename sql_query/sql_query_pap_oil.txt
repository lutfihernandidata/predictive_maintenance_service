WITH UNIT_POPULATION_LATEST AS (
    SELECT
        SRL_NUM, MODL_NUM, ROOM, PLNT, SORT_FLD, NAME_1 AS CUSTOMER_NAME,
        CASE WHEN ABC_INDICATOR='A' THEN 'FMC' ELSE 'NON-FMC' END AS CONTRACT
    FROM(
        SELECT 
            SRL_NUM, MODL_NUM, ROOM, PLNT, SORT_FLD, NAME_1, ABC_INDICATOR, CHG_ON,
            ROW_NUMBER()OVER(PARTITION BY SRL_NUM, MODL_NUM ORDER BY CHG_ON DESC, PPN_DTTM DESC) AS RN
        FROM SOR.SAP_UNIT_POPULASI zppls
        WHERE MODL_NUM IN ('PC2000-8', 'HD785-7')
    ) ranked_population
    WHERE RN=1
),

PAP_OIL_DEDUP AS(
    SELECT *
    FROM(
        SELECT 
            LAB_NUM, SAMPL_DT, RECV_DT, RPT_DT, UNIT_ID, UNIT_NO, SRL_NUM, COMPONENT, MODL_NUM,
            OIL_TP, OIL_MTRX, ORIG_VISC, MATRIX, HRS_KM_OH, HRS_KM_OC, HRS_KM_TOT, OIL_CHG, VISC_40, VISC_CST,
            T_B_N AS TBN, T_A_N AS TAN, MAGNESIUM, CALCIUM, ZINC, MOLYBDENUM, BORON, PHOSPHOR, SODIUM, POTASSIUM,
            SILICON, DILUTION, WATER, GLYCOL, IRON, COPPER, ALUMINIUM, CHROMIUM, NICKEL, TIN, LEAD1 AS LEAD, PQINDEX,
            DIR_TRANS, OXIDATION, NITRATION, SOX, ISO4406,
            ROW_NUMBER()OVER(PARTITION BY LAB_NUM ORDER BY PPN_DTTM DESC) RN
        FROM SOR.PAP_OIL
        WHERE MODL_NUM IN ('PC2000-8', 'HD785-7')
    ) pap_ranked
    WHERE RN=1
),

FIRST_PAP_VALIDATION AS (
    SELECT
        LAB_NUM, SAMPL_DT, RECV_DT, RPT_DT, UNIT_ID, unit.ROOM AS UNIT_NO, unit.SRL_NUM, COMPONENT, unit.MODL_NUM,
        OIL_TP, OIL_MTRX, ORIG_VISC, MATRIX, HRS_KM_OH, HRS_KM_OC, HRS_KM_TOT, OIL_CHG, VISC_40, VISC_CST,
        TBN, TAN, MAGNESIUM, CALCIUM, ZINC, MOLYBDENUM, BORON, PHOSPHOR, SODIUM, POTASSIUM,
        SILICON, DILUTION, WATER, GLYCOL, IRON, COPPER, ALUMINIUM, CHROMIUM, NICKEL, TIN, LEAD, PQINDEX,
        DIR_TRANS, OXIDATION, NITRATION, SOX, ISO4406
    FROM PAP_OIL_DEDUP pap
    INNER JOIN UNIT_POPULATION_LATEST unit
        ON (unit.SRL_NUM=pap.SRL_NUM and unit.MODL_NUM=pap.MODL_NUM)
),

SECOND_PAP_VALIDATION AS (
    SELECT
        LAB_NUM, SAMPL_DT, RECV_DT, RPT_DT, UNIT_ID, unit.ROOM AS UNIT_NO, unit.SRL_NUM, COMPONENT, unit.MODL_NUM,
        OIL_TP, OIL_MTRX, ORIG_VISC, MATRIX, HRS_KM_OH, HRS_KM_OC, HRS_KM_TOT, OIL_CHG, VISC_40, VISC_CST,
        TBN, TAN, MAGNESIUM, CALCIUM, ZINC, MOLYBDENUM, BORON, PHOSPHOR, SODIUM, POTASSIUM,
        SILICON, DILUTION, WATER, GLYCOL, IRON, COPPER, ALUMINIUM, CHROMIUM, NICKEL, TIN, LEAD, PQINDEX,
        DIR_TRANS, OXIDATION, NITRATION, SOX, ISO4406
    FROM PAP_OIL_DEDUP pap
    INNER JOIN UNIT_POPULATION_LATEST unit
        ON (unit.ROOM=pap.UNIT_NO)
    WHERE pap.LAB_NUM NOT IN (SELECT LAB_NUM FROM FIRST_PAP_VALIDATION)
),

THIRD_PAP_VALIDATION AS (
    SELECT
        LAB_NUM, SAMPL_DT, RECV_DT, RPT_DT, UNIT_ID, unit.SORT_FLD AS UNIT_NO, unit.SRL_NUM, COMPONENT, unit.MODL_NUM,
        OIL_TP, OIL_MTRX, ORIG_VISC, MATRIX, HRS_KM_OH, HRS_KM_OC, HRS_KM_TOT, OIL_CHG, VISC_40, VISC_CST,
        TBN, TAN, MAGNESIUM, CALCIUM, ZINC, MOLYBDENUM, BORON, PHOSPHOR, SODIUM, POTASSIUM,
        SILICON, DILUTION, WATER, GLYCOL, IRON, COPPER, ALUMINIUM, CHROMIUM, NICKEL, TIN, LEAD, PQINDEX,
        DIR_TRANS, OXIDATION, NITRATION, SOX, ISO4406
    FROM PAP_OIL_DEDUP pap
    INNER JOIN UNIT_POPULATION_LATEST unit
        ON (unit.SORT_FLD=pap.UNIT_NO)
    WHERE pap.LAB_NUM NOT IN (SELECT LAB_NUM FROM FIRST_PAP_VALIDATION) AND 
          pap.LAB_NUM NOT IN (SELECT LAB_NUM FROM SECOND_PAP_VALIDATION)
)

SELECT * FROM FIRST_PAP_VALIDATION
UNION ALL
SELECT * FROM SECOND_PAP_VALIDATION
UNION ALL
SELECT * FROM THIRD_PAP_VALIDATION